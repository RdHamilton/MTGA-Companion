name: Release GUI Application

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'
      include-daemon:
        description: 'Include daemon in release'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write

jobs:
  # Build daemon for all platforms first
  build-daemon-windows:
    name: Build Daemon (Windows)
    runs-on: windows-latest
    if: github.event.inputs.include-daemon != 'false'

    steps:
      - name: Checkout daemon repo
        uses: actions/checkout@v4
        with:
          repository: RdHamilton/mtga-tracker-daemon
          ref: master

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Build daemon
        run: dotnet publish ./src/mtga-tracker-daemon -c Release -r win-x64 --self-contained -o ./publish

      - name: Upload daemon artifact
        uses: actions/upload-artifact@v4
        with:
          name: daemon-windows
          path: ./publish/
          retention-days: 1

  build-daemon-macos:
    name: Build Daemon (macOS)
    runs-on: macos-latest
    if: github.event.inputs.include-daemon != 'false'

    steps:
      - name: Checkout daemon repo
        uses: actions/checkout@v4
        with:
          repository: RdHamilton/mtga-tracker-daemon
          ref: master

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Build daemon (universal)
        run: |
          dotnet publish ./src/mtga-tracker-daemon -c Release -r osx-x64 --self-contained -o ./publish-x64
          dotnet publish ./src/mtga-tracker-daemon -c Release -r osx-arm64 --self-contained -o ./publish-arm64

      - name: Upload x64 daemon artifact
        uses: actions/upload-artifact@v4
        with:
          name: daemon-macos-x64
          path: ./publish-x64/
          retention-days: 1

      - name: Upload arm64 daemon artifact
        uses: actions/upload-artifact@v4
        with:
          name: daemon-macos-arm64
          path: ./publish-arm64/
          retention-days: 1

  build-daemon-linux:
    name: Build Daemon (Linux)
    runs-on: ubuntu-latest
    if: github.event.inputs.include-daemon != 'false'

    steps:
      - name: Checkout daemon repo
        uses: actions/checkout@v4
        with:
          repository: RdHamilton/mtga-tracker-daemon
          ref: master

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Build daemon
        run: dotnet publish ./src/mtga-tracker-daemon -c Release -r linux-x64 --self-contained -o ./publish

      - name: Upload daemon artifact
        uses: actions/upload-artifact@v4
        with:
          name: daemon-linux
          path: ./publish/
          retention-days: 1

  # Build MTGA-Companion with daemon
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: [build-daemon-windows]
    if: always() && (needs.build-daemon-windows.result == 'success' || needs.build-daemon-windows.result == 'skipped')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download daemon artifact
      if: needs.build-daemon-windows.result == 'success'
      uses: actions/download-artifact@v4
      with:
        name: daemon-windows
        path: ./resources/daemon

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install Wails CLI
      run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

    - name: Build Windows Application
      run: wails build -platform windows/amd64 -clean

    - name: Bundle daemon with app
      if: needs.build-daemon-windows.result == 'success'
      run: |
        mkdir -p build/bin/daemon
        Copy-Item -Path resources/daemon/* -Destination build/bin/daemon/ -Recurse
      shell: pwsh

    - name: Create distribution archive
      run: |
        mkdir -p dist
        cd build/bin
        Compress-Archive -Path *, ../../README.md, ../../LICENSE -DestinationPath ../../dist/mtga-companion-windows-amd64.zip

    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: dist/*.zip
        retention-days: 7

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    needs: [build-daemon-macos]
    if: always() && (needs.build-daemon-macos.result == 'success' || needs.build-daemon-macos.result == 'skipped')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download daemon x64 artifact
      if: needs.build-daemon-macos.result == 'success'
      uses: actions/download-artifact@v4
      with:
        name: daemon-macos-x64
        path: ./resources/daemon-x64

    - name: Download daemon arm64 artifact
      if: needs.build-daemon-macos.result == 'success'
      uses: actions/download-artifact@v4
      with:
        name: daemon-macos-arm64
        path: ./resources/daemon-arm64

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install Wails CLI
      run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

    - name: Build macOS Application (Universal Binary)
      run: wails build -platform darwin/universal -clean

    - name: Bundle daemon with app
      if: needs.build-daemon-macos.result == 'success'
      run: |
        # Create daemon directory inside app bundle
        mkdir -p "build/bin/MTGA-Companion.app/Contents/Resources/daemon"
        # Copy both architectures (app will select at runtime based on arch)
        cp -R resources/daemon-x64/* "build/bin/MTGA-Companion.app/Contents/Resources/daemon/"
        # Store arm64 separately for runtime selection
        mkdir -p "build/bin/MTGA-Companion.app/Contents/Resources/daemon-arm64"
        cp -R resources/daemon-arm64/* "build/bin/MTGA-Companion.app/Contents/Resources/daemon-arm64/"

    - name: Create distribution archive
      run: |
        mkdir -p dist
        cd build/bin
        tar -czf ../../dist/mtga-companion-macos-universal.tar.gz *.app

    - name: Upload macOS artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-build
        path: dist/*.tar.gz
        retention-days: 7

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    needs: [build-daemon-linux]
    if: always() && (needs.build-daemon-linux.result == 'success' || needs.build-daemon-linux.result == 'skipped')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download daemon artifact
      if: needs.build-daemon-linux.result == 'success'
      uses: actions/download-artifact@v4
      with:
        name: daemon-linux
        path: ./resources/daemon

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc libgtk-3-dev libwebkit2gtk-4.0-dev

    - name: Install Wails CLI
      run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

    - name: Build Linux Application
      run: wails build -platform linux/amd64 -clean

    - name: Bundle daemon with app
      if: needs.build-daemon-linux.result == 'success'
      run: |
        mkdir -p build/bin/daemon
        cp -R resources/daemon/* build/bin/daemon/
        chmod +x build/bin/daemon/mtga-tracker-daemon

    - name: Create distribution archive
      run: |
        mkdir -p dist
        cd build/bin
        tar -czf ../../dist/mtga-companion-linux-amd64.tar.gz mtga-companion daemon README.md LICENSE 2>/dev/null || tar -czf ../../dist/mtga-companion-linux-amd64.tar.gz mtga-companion daemon

    - name: Upload Linux artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-build
        path: dist/*.tar.gz
        retention-days: 7

  create-release:
    name: Create GitHub Release
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Prepare release files
      run: |
        mkdir -p release
        find artifacts -type f \( -name "*.zip" -o -name "*.tar.gz" \) | xargs -I {} cp {} release/
        ls -lh release/

    - name: Generate changelog
      id: changelog
      run: |
        echo "## What's Changed" > changelog.md
        PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        if [ -n "$PREV_TAG" ]; then
          git log $PREV_TAG..HEAD --pretty=format:"* %s (%h)" >> changelog.md
          echo "" >> changelog.md
          echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/$PREV_TAG...${{ github.ref_name }}" >> changelog.md
        else
          echo "* Initial release" >> changelog.md
        fi

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: release/*
        body_path: changelog.md
        draft: false
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
