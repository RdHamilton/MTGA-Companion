name: CI

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
      - '.cursorrules'
      - 'CLAUDE.md'
      - 'README.md'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/PULL_REQUEST_TEMPLATE/**'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
      - '.cursorrules'
      - 'CLAUDE.md'
      - 'README.md'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/PULL_REQUEST_TEMPLATE/**'

permissions:
  contents: read

jobs:
  test:
    name: Test (macOS)
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'
        cache-dependency-path: go.sum

    - name: Set up Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci

    - name: Build frontend
      run: |
        cd frontend
        npm run build

    - name: Download dependencies
      run: go mod download

    - name: Verify dependencies
      run: go mod verify

    - name: Run tests with coverage (no race detection)
      run: go test -v -coverprofile=coverage.out -covermode=atomic ./...

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        files: ./coverage.out
        flags: unittests
        fail_ci_if_error: false

  test-race:
    name: Test with Race Detection (macOS)
    runs-on: macos-latest
    # Only run race detection on main branch to save CI time
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'
        cache-dependency-path: go.sum

    - name: Set up Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci

    - name: Build frontend
      run: |
        cd frontend
        npm run build

    - name: Download dependencies
      run: go mod download

    - name: Run tests with race detection
      run: go test -v -race -timeout=15m ./...

  frontend-tests:
    name: Frontend Component Tests
    runs-on: macos-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci

    - name: Run component tests
      run: |
        cd frontend
        npm run test:run

    - name: Generate coverage report
      run: |
        cd frontend
        npm run test:coverage

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        files: ./frontend/coverage/coverage-final.json
        flags: frontend
        fail_ci_if_error: false

    - name: Coverage Summary
      uses: irongut/CodeCoverageSummary@v1.3.0
      if: github.event_name == 'pull_request'
      with:
        filename: frontend/coverage/cobertura-coverage.xml
        badge: true
        fail_below_min: false
        format: markdown
        hide_branch_rate: false
        hide_complexity: true
        indicators: true
        output: both
        thresholds: '60 80'

    - name: Add Coverage PR Comment
      uses: marocchino/sticky-pull-request-comment@v2
      if: github.event_name == 'pull_request'
      with:
        recreate: true
        path: code-coverage-results.md

    - name: Upload test results and coverage
      if: always()
      uses: actions/upload-artifact@v6
      with:
        name: frontend-test-results
        path: |
          frontend/coverage/
          frontend/playwright-report/
        retention-days: 7

  # E2E tests with Playwright are commented out because they require a running Wails application
  # Wails apps need a display server and can't easily run in a headless CI environment
  # To enable E2E tests in CI, consider:
  # 1. Using a headless browser with Xvfb on Linux
  # 2. Building a web-only version of the app for E2E testing
  # 3. Running E2E tests locally or on a dedicated test environment
  #
  # e2e-tests:
  #   name: E2E Tests
  #   runs-on: ubuntu-latest
  #
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v6
  #
  #   - name: Set up Node.js
  #     uses: actions/setup-node@v6
  #     with:
  #       node-version: '20'
  #       cache: 'npm'
  #       cache-dependency-path: frontend/package-lock.json
  #
  #   - name: Install dependencies
  #     run: |
  #       cd frontend
  #       npm ci
  #
  #   - name: Install Playwright browsers
  #     run: |
  #       cd frontend
  #       npx playwright install chromium --with-deps
  #
  #   - name: Setup Xvfb (virtual display for headless)
  #     run: |
  #       sudo apt-get update
  #       sudo apt-get install -y xvfb
  #
  #   - name: Build and run Wails app in background
  #     run: |
  #       # This would require special setup to run Wails in CI
  #       # wails dev &
  #       # sleep 10  # Wait for app to start
  #
  #   - name: Run E2E tests
  #     run: |
  #       cd frontend
  #       xvfb-run npm run test:e2e
  #
  #   - name: Upload Playwright report
  #     if: always()
  #     uses: actions/upload-artifact@v6
  #     with:
  #       name: playwright-report
  #       path: frontend/playwright-report/
  #       retention-days: 7

  lint:
    name: Lint
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'
        cache-dependency-path: go.sum

    - name: Set up Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci

    - name: Build frontend
      run: |
        cd frontend
        npm run build

    - name: Run golangci-lint
      uses: golangci/golangci-lint-action@v9
      with:
        version: v2.6.2
        args: --timeout=5m

  format:
    name: Format Check
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'
        cache-dependency-path: go.sum

    - name: Install gofumpt
      run: go install mvdan.cc/gofumpt@v0.6.0

    - name: Check formatting
      run: |
        export PATH="$HOME/go/bin:$PATH"
        gofumpt -l . > gofumpt-output.txt
        if [ -s gofumpt-output.txt ]; then
          echo "The following files need formatting:"
          cat gofumpt-output.txt
          exit 1
        fi

  security:
    name: Security Scan
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'
        cache-dependency-path: go.sum

    - name: Install govulncheck
      run: go install golang.org/x/vuln/cmd/govulncheck@latest

    - name: Run govulncheck
      run: govulncheck ./...

  build:
    name: Build (macOS)
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'
        cache-dependency-path: go.sum

    - name: Build
      run: go build -v -o bin/mtga-companion ./cmd/mtga-companion

    - name: Upload artifacts
      uses: actions/upload-artifact@v6
      with:
        name: mtga-companion-macos
        path: bin/
        retention-days: 7
