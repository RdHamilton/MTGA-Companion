name: Build Daemon

on:
  workflow_call:
    inputs:
      daemon-ref:
        description: 'Git ref for daemon repo (branch, tag, or SHA)'
        required: false
        default: 'master'
        type: string
  workflow_dispatch:
    inputs:
      daemon-ref:
        description: 'Git ref for daemon repo (branch, tag, or SHA)'
        required: false
        default: 'master'

jobs:
  build-daemon-windows:
    name: Build Daemon (Windows)
    runs-on: windows-latest

    steps:
      - name: Checkout daemon repo
        uses: actions/checkout@v4
        with:
          repository: RdHamilton/mtga-tracker-daemon
          ref: ${{ inputs.daemon-ref || 'master' }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore ./src/mtga-tracker-daemon

      - name: Build
        run: dotnet publish ./src/mtga-tracker-daemon -c Release -r win-x64 --self-contained -o ./publish/win-x64

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: daemon-windows-x64
          path: ./publish/win-x64/
          retention-days: 1

  build-daemon-macos:
    name: Build Daemon (macOS)
    runs-on: macos-latest

    steps:
      - name: Checkout daemon repo
        uses: actions/checkout@v4
        with:
          repository: RdHamilton/mtga-tracker-daemon
          ref: ${{ inputs.daemon-ref || 'master' }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore ./src/mtga-tracker-daemon

      - name: Build x64
        run: dotnet publish ./src/mtga-tracker-daemon -c Release -r osx-x64 --self-contained -o ./publish/osx-x64

      - name: Build arm64
        run: dotnet publish ./src/mtga-tracker-daemon -c Release -r osx-arm64 --self-contained -o ./publish/osx-arm64

      - name: Upload x64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: daemon-macos-x64
          path: ./publish/osx-x64/
          retention-days: 1

      - name: Upload arm64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: daemon-macos-arm64
          path: ./publish/osx-arm64/
          retention-days: 1

  build-daemon-linux:
    name: Build Daemon (Linux)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout daemon repo
        uses: actions/checkout@v4
        with:
          repository: RdHamilton/mtga-tracker-daemon
          ref: ${{ inputs.daemon-ref || 'master' }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore ./src/mtga-tracker-daemon

      - name: Build
        run: dotnet publish ./src/mtga-tracker-daemon -c Release -r linux-x64 --self-contained -o ./publish/linux-x64

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: daemon-linux-x64
          path: ./publish/linux-x64/
          retention-days: 1
